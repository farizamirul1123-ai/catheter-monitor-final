<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catheter Monitoring System | Group 3 Console (PostgreSQL)</title> 
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --fb-dark: #202124; 
            --fb-card: #292a2d; 
            --fb-nav: #282a2e; 
            --fb-nav-active: #3b3d40; 
            --fb-text-light: #e8eaed; 
            --fb-text-secondary: #9aa0a6; 
            --fb-primary: #1a73e8; 
            --fb-green: #34a853;
            --fb-red: #ea4335;
            --fb-yellow: #fbbc04;
            --chart-line: #F0F0F0;
            --chart-grid-line: #3c4043; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--fb-dark);
            color: var(--fb-text-light);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background-color: var(--fb-nav);
            padding: 10px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            position: fixed;
            height: 100%;
            z-index: 999;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        .logo-section {
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--fb-text-light);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #3c4043;
            margin-bottom: 10px;
        }
        
        .nav-item {
            padding: 12px 25px;
            color: var(--fb-text-secondary);
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-item:hover { 
            background-color: #35363a; 
            color: var(--fb-text-light); 
        }
        
        .nav-item.active {
            background-color: var(--fb-nav-active);
            color: var(--fb-text-light);
            border-left: 4px solid var(--fb-primary);
            padding-left: 21px;
            font-weight: 600;
        }
        
        .nav-heading {
            padding: 15px 25px 5px;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--fb-text-secondary);
            text-transform: uppercase;
        }
        
        #sidebarToggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--fb-nav);
            color: var(--fb-text-light);
            border: 1px solid #3c4043;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1.2em;
            border-radius: 4px;
        }

        .content-area {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            margin-left: 280px; 
            width: calc(100% - 280px);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
                box-shadow: none;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .content-area {
                margin-left: 0;
                width: 100%;
                padding: 10px;
                padding-top: 60px;
            }
            #sidebarToggle {
                display: block;
            }
            .metric-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            .project-details-grid {
                grid-template-columns: 1fr;
            }
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 25px;
            border-bottom: 1px solid #3c4043;
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .page-title {
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .last-updated {
            font-size: 0.9em;
            color: var(--fb-text-secondary);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .card {
            background-color: var(--fb-card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px; 
        }
        
        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--fb-text-light);
            margin-bottom: 15px;
            border-bottom: 1px solid #3c4043;
            padding-bottom: 10px;
        }
        
        .metric-indicator {
            text-align: left;
            padding: 15px;
            border: 1px solid #3c4043;
            border-radius: 4px;
            min-height: 120px;
        }
        
        .indicator-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--fb-yellow);
        }
        
        .value-label {
            font-size: 0.9em;
            color: var(--fb-text-secondary);
            margin-top: 5px;
        }
        
        .project-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .team-member-card {
            background-color: #33363b;
            padding: 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid var(--fb-yellow);
        }
        
        .member-photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--fb-text-light);
            flex-shrink: 0;
            border: 2px solid var(--fb-primary);
            overflow: hidden;
        }

        .member-photo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .member-info h4 { 
            font-size: 1em; 
            font-weight: 700; 
            margin-bottom: 3px; 
        }
        
        .member-info p { 
            font-size: 0.85em; 
            color: var(--fb-text-secondary); 
        }
        
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        .log-table th, .log-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #3c4043;
            color: var(--fb-text-light);
        }
        
        .log-table th {
            color: var(--fb-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75em;
        }
        
        .control-group {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: var(--fb-nav-active);
            border: 1px solid #3c4043;
        }
        
        .control-group h4 {
            color: var(--fb-primary);
            margin-bottom: 10px;
            font-size: 1.05em;
            font-weight: 600;
        }
        
        .control-group button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 8px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .control-group button:hover {
            opacity: 0.8;
        }
        
        #contentDeviceStatus p strong {
             color: var(--fb-text-light) !important;
        }
        
        .status-message-value {
             font-size: 1.8em;
             font-weight: 700;
             line-height: 1.2;
        }
        
        .debug-console {
            background-color: #1a1a1a;
            border: 2px solid var(--fb-yellow);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .debug-console h4 {
            color: var(--fb-yellow);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .debug-log {
            color: var(--fb-text-light);
            padding: 5px 0;
            border-bottom: 1px solid #333;
            line-height: 1.5;
        }
        
        .debug-log.error { color: var(--fb-red); }
        .debug-log.success { color: var(--fb-green); }
        .debug-log.warning { color: var(--fb-yellow); }
        
        .connection-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .connection-status.online {
            background-color: var(--fb-green);
            color: white;
        }
        
        .connection-status.offline {
            background-color: var(--fb-red);
            color: white;
        }
        
        .project-description {
            line-height: 1.6; 
            color: var(--fb-text-secondary);
        }
        
        .project-description p {
            margin-bottom: 10px;
        }
        
        .project-description ul {
            margin: 15px 0 15px 20px; 
            list-style-type: disc; 
            color: var(--fb-primary);
        }
        
        .project-description li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    
    <button id="sidebarToggle">☰</button>

    <div class="sidebar" id="sidebar">
        <div class="logo-section">
            <i class="fas fa-database" style="color: var(--fb-primary);"></i>
            <span>Catheter Monitor</span>
        </div>

        <div class="nav-heading">CONSOLE</div>
        <div class="nav-item active" data-page="overview">
            <i class="fas fa-tachometer-alt"></i> Project Overview
        </div>
        
        <div class="nav-heading">CRITICAL ANALYTICS</div>
        <div class="nav-item" data-page="weight_history">
            <i class="fas fa-tint"></i> Urine Weight History
        </div>
        
        <div class="nav-heading">CONTROL SYSTEM</div>
        <div class="nav-item" data-page="alerts">
            <i class="fas fa-sliders-h"></i> Alert Configuration
        </div>
        <div class="nav-item" data-page="device_status">
            <i class="fas fa-server"></i> Device Status
        </div>
        
        <div class="nav-heading">DEBUG TOOLS</div>
        <div class="nav-item" data-page="debug">
            <i class="fas fa-bug"></i> Debug Console
        </div>
    </div>

    <div class="content-area">
        
        <div class="top-bar">
            <div>
                <div class="page-title" id="mainTitle">Project Overview</div>
                <span class="connection-status offline" id="apiConnectionStatus">API OFFLINE</span>
            </div>
            <div class="last-updated">Last updated: <span id="lastUpdatedTime">--</span></div>
        </div>

        <!-- OVERVIEW PAGE -->
        <div id="contentOverview" class="page-content">
            
<div class="card">
    <div class="card-title">Project Mission & Goals</div>
    <div class="project-description">
        <p style="color: var(--fb-text-light);">
            This project focuses on developing an IoT-based catheter monitoring system to enhance patient safety and reduce the risk of catheter overflow. 
            The system continuously monitors urine volume using a load cell sensor and sends real-time data to an IoT platform for remote monitoring.
        </p>
        
        <ul>
            <li>
                <strong style="color: var(--fb-yellow);">Weight Monitoring Module (Arduino & ESP32):</strong>
                Measures the weight of urine collected in the catheter bag in real time.
            </li>
            <li>
                <strong style="color: var(--fb-yellow);">Alert System:</strong>
                Activates a buzzer and sends notifications when preset weight thresholds are reached.
            </li>
        </ul>

        <p style="font-weight: 600; color: var(--fb-text-light);">Critical Goals:</p>
        <p style="color: var(--fb-red);">
            To provide timely alerts when the catheter bag reaches critical weight levels (e.g. 500g, 1000g, and 1500g), 
            helping caregivers take immediate action to prevent overflow and improve patient care.
        </p>
    </div>
</div>

        <div class="card">
                <div class="card-title">Group Members (Group 3)</div>
                <div class="project-details-grid" style="margin-top: 10px;">
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-primary);">
                            <img src="/static/fariz.jpg" alt="Fariz Amirul">
                        </div>
                        <div class="member-info">
                            <h4>FARIZ AMIRUL BIN FAIZALL</h4>
                            <p>08BEU24F3038</p>
                            <p style="color: var(--fb-yellow);">Lead Hardware Integration</p>
                        </div>
                    </div>
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-green);">
                            <img src="/static/safiah.jpg" alt="Safiah Azmi">
                        </div>
                        <div class="member-info">
                            <h4>SAFIAH BINTI AZMI</h4>
                            <p>08BEU24F3037</p>
                            <p style="color: var(--fb-yellow);">Data Management & System Integration</p>
                        </div>
                    </div>
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-red);">
                            <img src="/static/nurfitri.jpg" alt="Nurfitridiyani Sahar Rudin">
                        </div>
                        <div class="member-info">
                            <h4>NURFITRIDIYANI BINTI SAHAR RUDIN</h4>
                            <p>08BEU24F3046</p>
                            <p style="color: var(--fb-yellow);">AI Model Training & Validation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WEIGHT HISTORY PAGE -->
        <div id="contentWeightHistory" class="page-content" style="display:none;">
            
            <div class="metric-grid"> 
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-primary);">
                    <div class="indicator-value" id="currentWeightHistory">--</div>
                    <div class="value-label">Current Urine Weight (KG)</div>
                </div>
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-yellow);">
                    <div class="status-message-value" id="weightStatusMessage">--</div>
                    <div class="value-label">Urine Status Message (Level)</div>
                </div>
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-green);">
                    <div class="indicator-value" id="changeCountHistory">0</div>
                    <div class="value-label">Total Catheter Changes Logged</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Urine Weight Accumulation Trend (Last 50 Readings)</div>
                <p style="color: var(--fb-text-secondary); margin-bottom: 15px;">This chart shows the accumulation of urine weight over time with the critical 1.5kg limit.</p>
                <div style="height: 450px; padding-top: 10px;">
                    <canvas id="detailedWeightChart"></canvas>
                </div>
                <p style="text-align: right; color: var(--fb-red); margin-top: 10px; font-size: 0.9em;">Red dashed line: Critical Limit (1.5kg)</p>
            </div>
            
            <div class="card">
                <div class="card-title">Catheter Maintenance Log</div>
                <div style="overflow-x: auto;">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="changeLogBodyHistory">
                            <tr><td colspan="3" style="text-align: center; padding: 10px; color: var(--fb-text-secondary);">No catheter change records found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <!-- ALERTS PAGE -->
        <div id="contentAlerts" class="page-content" style="display:none;">
            
            <div class="control-group">
                <h4><i class="fab fa-telegram-plane" style="color: var(--fb-primary);"></i> Telegram Push Notification Status</h4>
                <p style="color: var(--fb-text-secondary); font-size: 0.9em; margin-bottom: 10px;">The Flask API manages notifications. Token/Chat ID configuration is stored in PostgreSQL.</p>
                
                <p style="font-size: 0.8em; color: var(--fb-text-secondary); margin-top: 10px;">PG Configuration Status: <strong id="telegramStatus" style="color: var(--fb-green);">Token & Chat ID Configured</strong></p>
            </div>
            
            <div class="control-group">
                <h4><i class="fas fa-bell" style="color: var(--fb-yellow);"></i> Buzzer & Alert Status Control</h4>
                <p style="color: var(--fb-text-secondary); margin-bottom: 10px;">Current Buzzer Status: <strong id="buzzerStatus" style="color: var(--fb-red);">--</strong></p>
                <button style="background-color: var(--fb-green);" onclick="controlBuzzer('ON')"><i class="fas fa-volume-up"></i> ENABLE BUZZER</button>
                <button style="background-color: var(--fb-red);" onclick="controlBuzzer('OFF')"><i class="fas fa-volume-off"></i> DISABLE BUZZER</button>
                <button style="background-color: var(--fb-primary);" onclick="controlBuzzer('RESET')"><i class="fas fa-undo"></i> RESET ALERTS & BUZZER</button>
                <p style="font-size: 0.8em; color: var(--fb-text-secondary); margin-top: 10px;">*RESET also resets alert spam status in PostgreSQL.</p>
            </div>

            <div class="control-group">
                <h4><i class="fas fa-calendar-check" style="color: var(--fb-green);"></i> Catheter Maintenance Logging</h4>
                <p style="color: var(--fb-text-secondary); margin-bottom: 10px;">Press this button to record a catheter change and reset the simulated weight.</p>
                <button style="background-color: var(--fb-yellow); color: #202124;" onclick="logCatheterChange()"><i class="fas fa-plus"></i> LOG CATHETER CHANGE</button>
                <p style="font-size: 0.8em; color: var(--fb-text-secondary); margin-top: 10px;">Total Changes: <strong id="controlChangeCount" style="color: var(--fb-yellow);">0</strong></p>
            </div>

            <div class="control-group" style="border-color: var(--fb-red);">
                <h4><i class="fas fa-exclamation-triangle" style="color: var(--fb-red);"></i> Reset Data (DANGER ZONE)</h4>
                <p style="color: var(--fb-text-secondary); margin-bottom: 10px;">Use only for testing. This will simulate deletion of ALL historical data in PostgreSQL.</p>
                <button style="background-color: var(--fb-red); color: white;" onclick="resetAllData()"><i class="fas fa-trash-alt"></i> RESET ALL DATA</button>
            </div>
        </div>
        
        <!-- DEVICE STATUS PAGE -->
        <div id="contentDeviceStatus" class="page-content" style="display:none;">
            <div class="card">
                <div class="card-title">Device & Network Status</div>
                <div style="padding-top: 10px; line-height: 2;">
                    <p>IP Address ESP32-CAM: <strong style="color: var(--fb-yellow);" id="ipAddress">192.168.x.xxx</strong></p>
                    <p>API Flask Server: <strong style="color: var(--fb-green);">https://catheter-monitor-final.onrender.com</strong></p>
                    <p>System Uptime: <strong style="color: var(--fb-primary);" id="deviceUptime">--</strong></p>
                    <p>ESP32 Connection: <strong id="esp32Connection" style="color: var(--fb-green);">Checking...</strong></p>
                </div>
            </div>
        </div>
        
        <!-- DEBUG CONSOLE PAGE -->
        <div id="contentDebug" class="page-content" style="display:none;">
            <div class="card">
                <div class="card-title"><i class="fas fa-bug"></i> Real-Time Debug Console</div>
                
                <div style="margin-bottom: 20px;">
                    <button style="background-color: var(--fb-primary); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px; font-weight: 600;" onclick="testAPIConnection()">
                        <i class="fas fa-plug"></i> Test API Connection
                    </button>
                    <button style="background-color: var(--fb-green); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px; font-weight: 600;" onclick="manualRefresh()">
                        <i class="fas fa-sync"></i> Manual Refresh Data
                    </button>
                    <button style="background-color: var(--fb-red); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600;" onclick="clearDebugLogs()">
                        <i class="fas fa-trash"></i> Clear Logs
                    </button>
                </div>
                
                <div class="debug-console" id="debugConsole">
                    <h4><i class="fas fa-terminal"></i> Console Output</h4>
                    <div id="debugLogs">
                        <div class="debug-log">System initialized. Waiting for API calls...</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title"><i class="fas fa-info-circle"></i> API Response Data (Raw JSON)</div>
                <pre id="rawAPIData" style="background-color: #1a1a1a; padding: 15px; border-radius: 4px; overflow-x: auto; color: var(--fb-text-light); font-size: 0.85em; max-height: 500px;">No data received yet. Click "Manual Refresh Data" to fetch from API.</pre>
            </div>
            
            <div class="card">
                <div class="card-title"><i class="fas fa-clipboard-check"></i> Troubleshooting Checklist</div>
                <div style="line-height: 2; color: var(--fb-text-secondary);">
                    <p><strong style="color: var(--fb-yellow);">If weight shows 0 or -- :</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Check if API status shows "ONLINE" (top right)</li>
                        <li>Click "Test API Connection" button above</li>
                        <li>Look for "weight_kg is NULL" warning in console logs</li>
                        <li>Verify ESP32 is sending POST requests to server</li>
                        <li>Check Flask server logs for incoming requests</li>
                    </ol>
                    
                    <p style="margin-top: 15px;"><strong style="color: var(--fb-red);">Common Issues:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>ESP32 not connected to WiFi</li>
                        <li>Wrong API endpoint in ESP32 code</li>
                        <li>Flask server not running</li>
                        <li>PostgreSQL connection error</li>
                        <li>CORS blocking request from browser</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" style="position: fixed; bottom: 30px; right: 30px; background: var(--fb-card); padding: 15px; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); color: var(--fb-text-light); display: none; z-index: 1000; border-left: 4px solid var(--fb-green); align-items: center; gap: 10px;">
        <i id="toastIcon" class="fas fa-check-circle" style="color: var(--fb-green); font-size: 1.5em;"></i>
        <div>
            <h4 id="toastTitle" style="color: var(--fb-green); margin: 0; font-size: 1em;">Success</h4>
            <p id="toastMessage" style="color: var(--fb-text-secondary); margin: 0; font-size: 0.9em;"></p>
        </div>
    </div>


    <script> 
        const API_URL = "https://catheter-monitor-final.onrender.com/api/v1"; 
        const MAX_WEIGHT_KG = 1.5; 
        const FETCH_INTERVAL = 3000;
        
        let detailedWeightChart = null;
        let chartsInitialized = { weight: false };
        let chartDataBuffer = { labels: [], weight: [] };
        let apiConnected = false;
        let fetchIntervalId = null;
        
        const addDebugLog = (message, type = 'info') => {
            const debugLogs = document.getElementById('debugLogs');
            if (!debugLogs) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log ${logClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            debugLogs.appendChild(logEntry);
            debugLogs.scrollTop = debugLogs.scrollHeight;
            
            const logs = debugLogs.querySelectorAll('.debug-log');
            if (logs.length > 100) {
                logs[0].remove();
            }
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        };
        
        window.clearDebugLogs = () => {
            const debugLogs = document.getElementById('debugLogs');
            if (debugLogs) {
                debugLogs.innerHTML = '<div class="debug-log">Logs cleared.</div>';
            }
            addDebugLog('Debug logs cleared by user', 'info');
        };
        
        window.testAPIConnection = async () => {
            addDebugLog('=== TESTING API CONNECTION ===', 'info');
            addDebugLog(`Target URL: ${API_URL}/status`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(API_URL + '/status', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addDebugLog(`Response Time: ${duration}ms`, 'info');
                addDebugLog(`HTTP Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    addDebugLog('✓ API Connection Successful!', 'success');
                    addDebugLog(`→ Weight from API: ${data.current_metrics?.weight_kg ?? 'NULL'} kg`, data.current_metrics?.weight_kg ? 'success' : 'warning');
                    addDebugLog(`→ Buzzer Status: ${data.current_metrics?.buzzer_status || 'NULL'}`, 'info');
                    addDebugLog(`→ History entries: ${data.weight_history?.length || 0}`, 'info');
                    addDebugLog(`→ Change logs: ${data.change_logs?.length || 0}`, 'info');
                    
                    if (!data.current_metrics?.weight_kg) {
                        addDebugLog('⚠ WARNING: weight_kg is NULL!', 'warning');
                        addDebugLog('⚠ ESP32 might not be sending data to server', 'warning');
                    }
                    
                    updateAPIStatus(true);
                } else {
                    addDebugLog(`✗ API returned error: ${response.statusText}`, 'error');
                    updateAPIStatus(false);
                }
            } catch (error) {
                addDebugLog(`✗ API Connection FAILED: ${error.message}`, 'error');
                addDebugLog('→ Possible causes:', 'error');
                addDebugLog('  - Server is offline', 'error');
                addDebugLog('  - CORS policy blocking request', 'error');
                addDebugLog('  - Network connectivity issue', 'error');
                addDebugLog('  - Wrong API URL', 'error');
                updateAPIStatus(false);
            }
            
            addDebugLog('=== TEST COMPLETED ===', 'info');
        };
        
        window.manualRefresh = () => {
            addDebugLog('Manual refresh triggered by user', 'info');
            fetchDataFromAPI();
        };
        
        const updateAPIStatus = (connected) => {
            apiConnected = connected;
            const statusEl = document.getElementById('apiConnectionStatus');
            const esp32El = document.getElementById('esp32Connection');
            
            if (statusEl) {
                statusEl.textContent = connected ? 'API ONLINE' : 'API OFFLINE';
                statusEl.className = connected ? 'connection-status online' : 'connection-status offline';
            }
            
            if (esp32El) {
                esp32El.textContent = connected ? 'Connected (based on API response)' : 'Disconnected';
                esp32El.style.color = connected ? 'var(--fb-green)' : 'var(--fb-red)';
            }
        };
        
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}h ${m}m ${s}s`;
        };
        
        const formatTimestamp = (ms) => {
            const ms_int = parseInt(ms);
            return new Date(ms_int).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        };
        
        const DOM = (id) => document.getElementById(id);
        
        const navItems = document.querySelectorAll('.nav-item');
        const sidebar = DOM('sidebar');
        const sidebarToggle = DOM('sidebarToggle');

        const closeSidebar = () => {
            if (window.innerWidth <= 768 && sidebar) {
                sidebar.classList.remove('active');
            }
        };

        const pageToContentId = (pageId) => {
            return 'content' + pageId
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
        };

        const initCharts = (pageId) => {
            if (typeof Chart === 'undefined') {
                addDebugLog('Chart.js not loaded yet', 'warning');
                return;
            }
            
            Chart.register(window['chartjs-plugin-annotation']); 

            const defaultOptions = {
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { 
                        bodyColor: '#202124', 
                        titleColor: '#202124', 
                        backgroundColor: '#F0F0F0', 
                        borderColor: '#3c4043', 
                        borderWidth: 1 
                    } 
                },
                scales: {
                    y: { 
                        ticks: { color: 'var(--chart-line)' }, 
                        grid: { color: 'var(--chart-grid-line)' }, 
                        title: { display: false } 
                    },
                    x: { 
                        ticks: { color: 'var(--chart-line)' }, 
                        grid: { display: false } 
                    }
                }
            };
            
            if (pageId === 'weight_history' && !chartsInitialized.weight) {
                const canvas = DOM('detailedWeightChart');
                if (canvas) {
                    detailedWeightChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: { 
                            labels: chartDataBuffer.labels, 
                            datasets: [{ 
                                label: 'Weight (kg)', 
                                data: chartDataBuffer.weight, 
                                borderColor: 'var(--fb-primary)', 
                                backgroundColor: 'rgba(26, 115, 232, 0.1)', 
                                tension: 0.2, 
                                pointRadius: 4, 
                                pointBackgroundColor: 'var(--fb-primary)' 
                            }] 
                        },
                        options: { 
                            ...defaultOptions, 
                            plugins: { 
                                ...defaultOptions.plugins, 
                                annotation: { 
                                    annotations: { 
                                        criticalLimit: { 
                                            type: 'line', 
                                            yMin: MAX_WEIGHT_KG, 
                                            yMax: MAX_WEIGHT_KG, 
                                            borderColor: '#FFFFFF', 
                                            borderWidth: 3, 
                                            borderDash: [8, 4], 
                                            label: { 
                                                content: 'CRITICAL LIMIT (1.5 KG)', 
                                                enabled: true, 
                                                position: 'start', 
                                                backgroundColor: 'var(--fb-red)',
                                                color: '#FFFFFF'
                                            } 
                                        } 
                                    } 
                                } 
                            }, 
                            scales: { 
                                ...defaultOptions.scales, 
                                y: { 
                                    ...defaultOptions.scales.y, 
                                    min: 0, 
                                    max: MAX_WEIGHT_KG * 1.1, 
                                    suggestedMax: MAX_WEIGHT_KG * 1.05, 
                                    border: { color: 'var(--chart-grid-line)' }, 
                                    title: { 
                                        display: true, 
                                        text: 'Urine Weight (KG)', 
                                        color: 'var(--chart-line)' 
                                    }, 
                                    ticks: { color: 'var(--chart-line)' }, 
                                    grid: { color: 'var(--chart-grid-line)' } 
                                }, 
                                x: { 
                                    ...defaultOptions.scales.x, 
                                    ticks: { color: 'var(--chart-line)' } 
                                } 
                            } 
                        }
                    });
                    chartsInitialized.weight = true;
                    addDebugLog('Weight history chart initialized', 'success');
                }
            }
        };

        const switchPage = (pageId) => {
            addDebugLog(`Switching to page: ${pageId}`, 'info');
            
            document.querySelectorAll('.page-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const contentId = pageToContentId(pageId);
            const activeContent = DOM(contentId); 
            
            if (!activeContent) {
                addDebugLog(`ERROR: Content not found for ${contentId}`, 'error');
                return;
            }

            activeContent.style.display = 'block';
            
            if (DOM('mainTitle')) {
                DOM('mainTitle').textContent = pageId
                    .replace(/_/g, ' ')
                    .split(' ')
                    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                    .join(' ');
            }

            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                }
            });
            
            closeSidebar();

            if (pageId === 'weight_history' && !chartsInitialized.weight) {
                initCharts(pageId);
            }

            setTimeout(() => {
                if (detailedWeightChart) detailedWeightChart.resize();
            }, 100); 
        };

        const fetchDataFromAPI = async () => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); 
                
                const response = await fetch(API_URL + '/status', { 
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (DOM('rawAPIData')) {
                    DOM('rawAPIData').textContent = JSON.stringify(data, null, 2);
                }
                
                if (data.status === "error") {
                    addDebugLog(`API returned error: ${data.message}`, 'error');
                    throw new Error(data.message);
                }
                
                updateAPIStatus(true);
                
                const metrics = data.current_metrics || {};
                const history = data.weight_history ? [...data.weight_history].reverse() : []; 
                const changeLogs = data.change_logs || [];

                updateMetrics(metrics, history, changeLogs);
                updateCharts(history);

            } catch (error) {
                addDebugLog(`Fetch error: ${error.message}`, 'error');
                updateAPIStatus(false);
            }
        };

        const updateMetrics = (metrics, history, changeLogs) => {
            const formattedWeight = metrics.weight_kg != null ? metrics.weight_kg.toFixed(2) : '--';
            if (DOM('currentWeightHistory')) DOM('currentWeightHistory').textContent = formattedWeight;
            
            if (DOM('changeCountHistory')) DOM('changeCountHistory').textContent = metrics.change_count || 0; 
            if (DOM('controlChangeCount')) DOM('controlChangeCount').textContent = metrics.change_count || 0; 
            
            if (DOM('buzzerStatus')) {
                DOM('buzzerStatus').textContent = metrics.buzzer_status || 'OFF';
                DOM('buzzerStatus').style.color = metrics.buzzer_status === 'ON' ? 'var(--fb-red)' : 'var(--fb-green)';
            }
            
            let statusText = metrics.status_message || 'UNKNOWN';

            if (DOM('weightStatusMessage')) {
                DOM('weightStatusMessage').textContent = statusText; 
                if (metrics.alert_level === 'LEVEL_1500_DANGER') {
                    DOM('weightStatusMessage').style.color = 'var(--fb-red)';
                } else if (metrics.alert_level === 'LEVEL_1000_REACHED') {
                    DOM('weightStatusMessage').style.color = 'var(--fb-yellow)';
                } else {
                    DOM('weightStatusMessage').style.color = 'var(--fb-green)';
                }
            }
            
            if (DOM('lastUpdatedTime') && history.length > 0) {
                DOM('lastUpdatedTime').textContent = formatTimestamp(history[0].timestamp);
            } else if (DOM('lastUpdatedTime')) {
                DOM('lastUpdatedTime').textContent = new Date().toLocaleTimeString();
            }
            
            updateChangeLog(changeLogs, DOM('changeLogBodyHistory'));
        };

        const updateCharts = (history) => {
            if (history.length >= 2) {
                chartDataBuffer.labels = history.map(h => formatTimestamp(h.timestamp));
                chartDataBuffer.weight = history.map(h => h.weight || 0);
                
                if (detailedWeightChart) {
                    detailedWeightChart.data.labels = chartDataBuffer.labels;
                    detailedWeightChart.data.datasets[0].data = chartDataBuffer.weight;
                    detailedWeightChart.update('none');
                }
            } else {
                if (detailedWeightChart) {
                    detailedWeightChart.data.labels = [];
                    detailedWeightChart.data.datasets[0].data = [];
                    detailedWeightChart.update('none');
                }
            }
        };

        const updateChangeLog = (changeLogs, targetElement) => {
            if (!targetElement) return;
            
            let logHtml = '';
            changeLogs.forEach(log => {
                logHtml += `
                    <tr>
                        <td style="color: var(--fb-primary);">${log.id}</td>
                        <td style="color: var(--fb-text-light);">${new Date(log.timestamp).toLocaleDateString()}</td>
                        <td style="color: var(--fb-text-light);">${formatTimestamp(new Date(log.timestamp).getTime())}</td>
                    </tr>
                `;
            });

            targetElement.innerHTML = logHtml.length > 0 ? logHtml : 
                '<tr><td colspan="3" style="text-align: center; padding: 10px; color: var(--fb-text-secondary);">No catheter change records found.</td></tr>';
        };

        window.controlBuzzer = async (command) => {
            addDebugLog(`Sending buzzer command: ${command}`, 'info');
            try {
                const response = await fetch(API_URL + '/control_buzzer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                
                if (response.ok) {
                    showToast('Control Sent', `Buzzer command: ${command} sent successfully.`, command === 'ON' ? 'danger' : 'success');
                    addDebugLog(`✓ Buzzer ${command} command successful`, 'success');
                    setTimeout(fetchDataFromAPI, 500);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showToast('API Error', `Failed to send command: ${error.message}`, 'danger');
                addDebugLog(`✗ Buzzer command failed: ${error.message}`, 'error');
            }
        };

        window.logCatheterChange = async () => {
            addDebugLog('Logging catheter change...', 'info');
            try {
                const response = await fetch(API_URL + '/log_change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    showToast('Success', 'Catheter change logged and weight reset.', 'success');
                    addDebugLog('✓ Catheter change logged successfully', 'success');
                    setTimeout(fetchDataFromAPI, 500);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showToast('API Error', `Failed to log change: ${error.message}`, 'danger');
                addDebugLog(`✗ Log catheter change failed: ${error.message}`, 'error');
            }
        };
        
        window.resetAllData = () => { 
            if (confirm('Are you sure you want to RESET ALL DATA? This action cannot be undone!')) {
                addDebugLog('RESET ALL DATA command triggered (simulated)', 'warning');
                showToast('Simulated', 'RESET ALL DATA command would execute here.', 'danger'); 
            }
        };

        window.showToast = (title, message, type = 'info', duration = 4000) => {
            const toast = DOM('toast');
            const toastTitle = DOM('toastTitle');
            const toastMessage = DOM('toastMessage');
            const toastIcon = DOM('toastIcon');
            
            if (!toast) return;

            let color = 'var(--fb-primary)';
            let iconClass = 'fas fa-info-circle';

            if (type === 'success') { 
                color = 'var(--fb-green)'; 
                iconClass = 'fas fa-check-circle'; 
            } else if (type === 'danger') { 
                color = 'var(--fb-red)'; 
                iconClass = 'fas fa-exclamation-triangle'; 
            } else if (type === 'info') { 
                color = 'var(--fb-yellow)'; 
                iconClass = 'fas fa-exclamation-circle'; 
            }

            toast.style.borderLeftColor = color;
            toastTitle.style.color = color;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toastIcon.className = iconClass;
            toastIcon.style.color = color;

            toast.style.display = 'flex';
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.style.display = 'none', 500);
            }, duration);
        };

        document.addEventListener('DOMContentLoaded', () => {
            addDebugLog('=== DASHBOARD INITIALIZATION ===', 'success');
            addDebugLog(`API URL: ${API_URL}`, 'info');
            addDebugLog(`Fetch Interval: ${FETCH_INTERVAL}ms`, 'info');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const pageId = item.getAttribute('data-page');
                    switchPage(pageId);
                });
            });
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    if (sidebar) sidebar.classList.toggle('active');
                });
            }
            
            switchPage('overview'); 
            
            addDebugLog('Testing initial API connection...', 'info');
            testAPIConnection();
            
            fetchIntervalId = setInterval(fetchDataFromAPI, FETCH_INTERVAL); 
            addDebugLog(`Auto-refresh enabled (every ${FETCH_INTERVAL/1000}s)`, 'success');
            
            setInterval(() => {
                if (DOM('deviceUptime')) {
                    const uptime = Math.floor((Date.now() - window.startTime) / 1000);
                    DOM('deviceUptime').textContent = formatTime(uptime);
                }
            }, 1000);
            
            window.startTime = Date.now();
            addDebugLog('=== INITIALIZATION COMPLETE ===', 'success');
        });

    </script>
</body>
</html>