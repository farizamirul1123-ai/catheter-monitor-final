<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UROTECH Console | Group 3</title> 
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --fb-dark: #202124; 
            --fb-card: #292a2d; 
            --fb-nav: #282a2e; 
            --fb-nav-active: #3b3d40; 
            --fb-text-light: #ffffff; 
            --fb-text-secondary: #9aa0a6; 
            --fb-primary: #1a73e8; 
            --fb-green: #34a853;
            --fb-red: #ea4335;
            --fb-yellow: #fbbc04;
            --chart-line: #FFFFFF; 
            --chart-grid-line: #3c4043; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--fb-dark);
            color: var(--fb-text-light);
            min-height: 100vh;
            display: flex;
        }

        /* --- SIDEBAR STYLE --- */
        .sidebar {
            width: 280px;
            background-color: var(--fb-nav);
            padding: 10px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            position: fixed;
            height: 100%;
            z-index: 999;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        .logo-section {
            padding: 15px 25px;
            font-size: 1.3em; /* Besar sikit */
            font-weight: 800; /* Tebal */
            color: var(--fb-text-light);
            display: flex;
            align-items: center;
            gap: 15px; 
            border-bottom: 1px solid #3c4043;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .logo-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--fb-primary);
        }
        
        .nav-item {
            padding: 12px 25px;
            color: var(--fb-text-secondary);
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-item:hover { background-color: #35363a; color: var(--fb-text-light); }
        
        .nav-item.active {
            background-color: var(--fb-nav-active);
            color: var(--fb-text-light);
            border-left: 4px solid var(--fb-primary);
            padding-left: 21px;
            font-weight: 600;
        }
        
        .nav-heading {
            padding: 15px 25px 5px;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--fb-text-secondary);
            text-transform: uppercase;
        }

        /* Language Buttons */
        .lang-btn-group { padding: 10px 20px; display: flex; gap: 10px; }
        .lang-btn {
            background-color: #3c4043; color: white; border: 1px solid #5f6368;
            padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;
            text-align: center; flex: 1; transition: all 0.2s;
        }
        .lang-btn:hover { background-color: var(--fb-primary); border-color: var(--fb-primary); }
        .lang-btn.active-lang { background-color: var(--fb-primary); border-color: var(--fb-primary); font-weight: bold; }

        /* --- CONTENT STYLE --- */
        .content-area {
            flex-grow: 1; padding: 30px; overflow-y: auto;
            margin-left: 280px; width: calc(100% - 280px);
        }
        
        #sidebarToggle {
            display: none; position: fixed; top: 10px; left: 10px; z-index: 1000;
            background: var(--fb-nav); color: var(--fb-text-light);
            border: 1px solid #3c4043; padding: 10px 15px; cursor: pointer;
            font-size: 1.2em; border-radius: 4px;
        }

        /* --- MOBILE RESPONSIVE FIXES --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-280px); box-shadow: none; }
            .sidebar.active { transform: translateX(0); }
            .content-area { margin-left: 0; width: 100%; padding: 15px; padding-top: 60px; }
            #sidebarToggle { display: block; }
            .metric-grid { grid-template-columns: 1fr !important; gap: 15px; }
            
            .project-details-grid { grid-template-columns: 1fr !important; }
            .team-member-card {
                flex-direction: row; 
                align-items: center;
                padding: 10px;
                width: 100%;
                box-sizing: border-box; 
            }
            .member-info { overflow: hidden; }
            .member-info h4 { font-size: 0.9em; white-space: normal; }
        }

        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 25px; border-bottom: 1px solid #3c4043; padding-bottom: 15px;
            flex-wrap: wrap; gap: 10px;
        }
        
        .page-title { font-size: 1.8em; font-weight: 700; color: #ffffff; }
        .last-updated { font-size: 0.9em; color: var(--fb-text-secondary); }
        
        .metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        
        .card {
            background-color: var(--fb-card); padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); margin-bottom: 20px; 
        }
        
        .card-title {
            font-size: 1.1em; font-weight: 600; color: #ffffff; 
            margin-bottom: 15px; border-bottom: 1px solid #3c4043; padding-bottom: 10px;
        }
        
        .metric-indicator {
            text-align: left; padding: 15px; border: 1px solid #3c4043;
            border-radius: 4px; min-height: 120px;
        }
        
        .indicator-value { font-size: 2em; font-weight: 700; color: #ffffff !important; }
        .status-message-value { font-size: 1.5em; font-weight: 700; line-height: 1.2; color: #ffffff; }
        .value-label { font-size: 0.9em; color: var(--fb-text-secondary); margin-top: 5px; }
        
        .project-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .team-member-card {
            background-color: #33363b; padding: 15px; border-radius: 6px;
            display: flex; align-items: center; gap: 15px; border-left: 4px solid var(--fb-yellow);
        }
        
        .member-photo-placeholder {
            width: 50px; height: 50px; border-radius: 50%;
            background-color: #555; display: flex; align-items: center; justify-content: center;
            font-size: 1.2em; color: var(--fb-text-light); flex-shrink: 0;
            border: 2px solid var(--fb-primary); overflow: hidden;
        }
        .member-photo-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        
        .member-info h4 { font-size: 0.95em; font-weight: 700; margin-bottom: 3px; color: white; }
        .member-info p { font-size: 0.8em; color: var(--fb-text-secondary); }
        
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .log-table th, .log-table td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #3c4043; color: white; }
        .log-table th { color: var(--fb-text-secondary); font-weight: 500; text-transform: uppercase; font-size: 0.75em; }
        
        .control-group {
            padding: 15px; margin-bottom: 15px; border-radius: 6px;
            background-color: var(--fb-nav-active); border: 1px solid #3c4043;
        }
        .control-group h4 { color: var(--fb-primary); margin-bottom: 10px; font-size: 1.05em; font-weight: 600; }
        .control-group button {
            padding: 10px 15px; border: none; border-radius: 4px; color: white;
            font-weight: 600; cursor: pointer; transition: background-color 0.2s;
            margin-right: 8px; margin-top: 5px; font-size: 0.9em;
        }
        .control-group button:hover { opacity: 0.8; }
        
        .debug-console {
            background-color: #1a1a1a; border: 2px solid var(--fb-yellow);
            border-radius: 8px; padding: 15px; margin-top: 20px;
            font-family: 'Courier New', monospace; font-size: 0.85em;
            max-height: 400px; overflow-y: auto;
        }
        .debug-console h4 { color: var(--fb-yellow); margin-bottom: 10px; font-size: 1.1em; }
        .debug-log { color: var(--fb-text-light); padding: 5px 0; border-bottom: 1px solid #333; line-height: 1.5; }
        
        .connection-status {
            display: inline-block; padding: 5px 12px; border-radius: 4px;
            font-size: 0.85em; font-weight: 600; margin-left: 10px;
        }
        .connection-status.online { background-color: var(--fb-green); color: white; }
        .connection-status.offline { background-color: var(--fb-red); color: white; }
        
        .project-description { line-height: 1.6; color: white; } 
        .project-description p { margin-bottom: 10px; color: white !important; }
        .project-description ul { margin: 15px 0 15px 20px; list-style-type: none; padding: 0; }
        .project-description li { margin-bottom: 12px; color: white; position: relative; padding-left: 25px; }
        .project-description li i { position: absolute; left: 0; top: 3px; }
    </style>
</head>
<body>
    
    <button id="sidebarToggle">☰</button>

    <div class="sidebar" id="sidebar">
        <div class="logo-section">
            <img src="/static/fpf.jpg" alt="Logo" class="logo-img">
            <span>UROTECH</span>
        </div>

        <div class="lang-btn-group">
            <button class="lang-btn" id="btn-ms" onclick="setLanguage('ms')">Bahasa Malaysia</button>
            <button class="lang-btn" id="btn-en" onclick="setLanguage('en')">English</button>
        </div>

        <div class="nav-heading" data-key="nav_console">CONSOLE</div>
        <div class="nav-item active" data-page="overview">
            <i class="fas fa-tachometer-alt"></i> <span data-key="nav_overview">Project Overview</span>
        </div>
        
        <div class="nav-heading" data-key="nav_analytics">CRITICAL ANALYTICS</div>
        <div class="nav-item" data-page="weight_history">
            <i class="fas fa-tint"></i> <span data-key="nav_history">Urine Weight History</span>
        </div>
        
        <div class="nav-heading" data-key="nav_control">CONTROL SYSTEM</div>
        <div class="nav-item" data-page="alerts">
            <i class="fas fa-sliders-h"></i> <span data-key="nav_config">Maintenance Config</span>
        </div>
        <div class="nav-item" data-page="device_status">
            <i class="fas fa-server"></i> <span data-key="nav_device">Device Status</span>
        </div>
        
        <div class="nav-heading">DEBUG TOOLS</div>
        <div class="nav-item" data-page="debug" id="btnDebug">
            <i class="fas fa-bug"></i> <span data-key="nav_debug">Debug Console</span>
        </div>
    </div>

    <div class="content-area">
        
        <div class="top-bar">
            <div>
                <div class="page-title" id="mainTitle">Project Overview</div>
                <span class="connection-status offline" id="apiConnectionStatus">API OFFLINE</span>
            </div>
            <div class="last-updated"><span data-key="last_updated">Last updated:</span> <span id="lastUpdatedTime">--</span></div>
        </div>

        <div id="contentOverview" class="page-content">
            
            <div class="card">
                <div class="card-title" data-key="mission_title">Project Mission & Goals</div>
                <div class="project-description">
                    <p id="desc_p1">
                        This project focuses on developing an IoT-based catheter monitoring system to enhance patient safety and reduce the risk of catheter overflow. 
                        The system continuously monitors urine volume using a load cell sensor and sends real-time data to an IoT platform for remote monitoring.
                    </p>
                    
                    <ul>
                        <li>
                            <i class="fas fa-weight-hanging" style="color: var(--fb-yellow);"></i>
                            <strong style="color: #ffffff;" id="title_weight">Weight Monitoring Module:</strong>
                            <span id="desc_li1">Measures the weight of urine collected in the catheter bag in real time.</span>
                        </li>
                        <li>
                            <i class="fas fa-bell" style="color: var(--fb-yellow);"></i>
                            <strong style="color: #ffffff;" id="title_alert">Alert System:</strong>
                            <span id="desc_li2">Activates a buzzer and sends notifications when preset weight thresholds are reached.</span>
                        </li>
                    </ul>

                    <p style="font-weight: 600; color: #ffffff;" data-key="crit_goals">Critical Goals:</p>
                    <p style="color: white;" id="desc_p2">
                        To provide timely alerts when the catheter bag reaches critical weight levels (e.g. 500g, 1000g, and 1500g), 
                        helping caregivers take immediate action to prevent overflow and improve patient care.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-title" data-key="group_members">Group Members (Group 3)</div>
                <div class="project-details-grid" style="margin-top: 10px;">
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-primary);">
                            <img src="/static/fariz.jpg" alt="Fariz">
                        </div>
                        <div class="member-info">
                            <h4>FARIZ AMIRUL BIN FAIZALL</h4>
                            <p>08BEU24F3038</p>
                            <p style="color: var(--fb-yellow);">Lead Hardware Integration</p>
                        </div>
                    </div>
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-green);">
                            <img src="/static/safiah.jpg" alt="Safiah">
                        </div>
                        <div class="member-info">
                            <h4>SAFIAH BINTI AZMI</h4>
                            <p>08BEU24F3037</p>
                            <p style="color: var(--fb-yellow);">Data Management & System Integration</p>
                        </div>
                    </div>
                    <div class="team-member-card">
                        <div class="member-photo-placeholder" style="background-color: var(--fb-red);">
                            <img src="/static/nurfitri.jpg" alt="Nurfitri">
                        </div>
                        <div class="member-info">
                            <h4>NURFITRIDIYANI BINTI SAHAR RUDIN</h4>
                            <p>08BEU24F3046</p>
                            <p style="color: var(--fb-yellow);">AI Model Training & Validation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="contentWeightHistory" class="page-content" style="display:none;">
            
            <div class="metric-grid"> 
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-primary);">
                    <div class="indicator-value" id="currentWeightHistory">--</div>
                    <div class="value-label" data-key="lbl_weight">Current Urine Weight (KG)</div>
                </div>
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-yellow);">
                    <div class="status-message-value" id="weightStatusMessage">Checking...</div>
                    <div class="value-label" data-key="lbl_status">Urine Status Message (Level)</div>
                </div>
                <div class="metric-indicator" style="border-left: 4px solid var(--fb-green);">
                    <div class="indicator-value" id="changeCountHistory">0</div>
                    <div class="value-label" data-key="lbl_total_changes">Total Catheter Changes Logged</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title" data-key="chart_title">Urine Weight Accumulation Trend (Last 50 Readings)</div>
                <p style="color: var(--fb-text-secondary); margin-bottom: 15px;" data-key="chart_desc">This chart shows the accumulation of urine weight over time with the critical 1.5kg limit.</p>
                <div style="height: 450px; padding-top: 10px;">
                    <canvas id="detailedWeightChart"></canvas>
                </div>
                <p style="text-align: right; color: var(--fb-red); margin-top: 10px; font-size: 0.9em;" data-key="chart_legend">Red dashed line: Critical Limit (1.5kg)</p>
            </div>
            
            <div class="card">
                <div class="card-title" data-key="log_title">Catheter Maintenance Log</div>
                <div style="overflow-x: auto;">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th data-key="col_date">Date</th>
                                <th data-key="col_time">Time</th>
                            </tr>
                        </thead>
                        <tbody id="changeLogBodyHistory">
                            <tr><td colspan="3" style="text-align: center; padding: 10px; color: var(--fb-text-secondary);">No records found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <div id="contentAlerts" class="page-content" style="display:none;">
            
            <div class="control-group">
                <h4><i class="fab fa-telegram-plane" style="color: var(--fb-primary);"></i> Telegram Push Notification Status</h4>
                <p style="color: white; font-size: 0.9em; margin-bottom: 10px;" data-key="tele_desc">The Flask API manages notifications. Token/Chat ID configuration is stored in PostgreSQL.</p>
                <p style="font-size: 0.8em; color: var(--fb-text-secondary); margin-top: 10px;">PG Configuration Status: <strong id="telegramStatus" style="color: var(--fb-green);">Token & Chat ID Configured</strong></p>
            </div>

            <div class="control-group">
                <h4><i class="fas fa-calendar-check" style="color: var(--fb-green);"></i> Catheter Maintenance Logging</h4>
                <p style="color: white; margin-bottom: 10px;" data-key="log_action_desc">Press this button to record a catheter change and reset the simulated weight.</p>
                <button style="background-color: var(--fb-yellow); color: #202124;" onclick="logCatheterChange()"><i class="fas fa-plus"></i> <span data-key="btn_log">LOG CATHETER CHANGE</span></button>
                <p style="font-size: 0.8em; color: var(--fb-text-secondary); margin-top: 10px;"><span data-key="lbl_total_changes">Total Changes:</span> <strong id="controlChangeCount" style="color: white;">0</strong></p>
            </div>

            <div class="control-group" style="border-color: var(--fb-primary);">
                <h4 id="title_data_mgmt">Data Management (Export & Reset)</h4>
                <p style="color: white; margin-bottom: 10px;" id="desc_data_mgmt">Download maintenance logs to Excel before clearing them from the system.</p>
                
                <button style="background-color: var(--fb-green);" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i> <span data-key="btn_export">EXPORT EXCEL / CSV</span>
                </button>

                <button style="background-color: var(--fb-red);" onclick="clearServerLogs()">
                    <i class="fas fa-trash-alt"></i> <span data-key="btn_clear_server">CLEAR ALL LOGS (START FRESH)</span>
                </button>
            </div>

        </div>
        
        <div id="contentDeviceStatus" class="page-content" style="display:none;">
            <div class="card">
                <div class="card-title" data-key="nav_device">Device & Network Status</div>
                <div style="padding-top: 10px; line-height: 2;">
                    <p>IP Address ESP32-CAM: <strong style="color: var(--fb-yellow);" id="ipAddress">192.168.x.xxx</strong></p>
                    <p>API Flask Server: <strong style="color: var(--fb-green);">https://catheter-monitor-final.onrender.com</strong></p>
                    <p>System Uptime: <strong style="color: var(--fb-primary);" id="deviceUptime">--</strong></p>
                    <p>ESP32 Connection: <strong id="esp32Connection" style="color: var(--fb-green);">Checking...</strong></p>
                </div>
            </div>
        </div>
        
        <div id="contentDebug" class="page-content" style="display:none;">
            <div class="card">
                <div class="card-title"><i class="fas fa-bug"></i> Real-Time Debug Console</div>
                <div style="margin-bottom: 20px;">
                    <button style="background-color: var(--fb-primary); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px; font-weight: 600;" onclick="testAPIConnection()"><i class="fas fa-plug"></i> Test API</button>
                    <button style="background-color: var(--fb-green); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px; font-weight: 600;" onclick="manualRefresh()"><i class="fas fa-sync"></i> Refresh Data</button>
                    <button style="background-color: var(--fb-red); padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600;" onclick="clearDebugLogs()"><i class="fas fa-trash"></i> Clear Logs</button>
                </div>
                <div class="debug-console" id="debugConsole">
                    <h4><i class="fas fa-terminal"></i> Console Output</h4>
                    <div id="debugLogs"><div class="debug-log">System initialized. Waiting for API calls...</div></div>
                </div>
            </div>
        </div>

    </div>

    <div id="toast" style="position: fixed; bottom: 30px; right: 30px; background: var(--fb-card); padding: 15px; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); color: var(--fb-text-light); display: none; z-index: 1000; border-left: 4px solid var(--fb-green); align-items: center; gap: 10px;">
        <i id="toastIcon" class="fas fa-check-circle" style="color: var(--fb-green); font-size: 1.5em;"></i>
        <div>
            <h4 id="toastTitle" style="color: var(--fb-green); margin: 0; font-size: 1em;">Success</h4>
            <p id="toastMessage" style="color: var(--fb-text-secondary); margin: 0; font-size: 0.9em;"></p>
        </div>
    </div>

    <script> 
        const API_URL = "https://catheter-monitor-final.onrender.com/api/v1"; 
        const MAX_WEIGHT_KG = 1.5; 
        const FETCH_INTERVAL = 3000;

        let detailedWeightChart = null;
        let chartsInitialized = { weight: false };
        let chartDataBuffer = { labels: [], weight: [] };
        let currentLang = localStorage.getItem('preferredLang') || 'en';
        
        // --- TRANSLATION DICTIONARY ---
        const dictionary = {
            en: {
                nav_console: "CONSOLE",
                nav_overview: "Project Overview",
                nav_analytics: "CRITICAL ANALYTICS",
                nav_history: "Urine Weight History",
                nav_control: "CONTROL SYSTEM",
                nav_config: "Maintenance Config",
                nav_device: "Device Status",
                nav_debug: "Debug Console",
                last_updated: "Last updated:",
                mission_title: "Project Mission & Goals",
                group_members: "Group Members (Group 3)",
                desc_p1: "This project focuses on developing an IoT-based catheter monitoring system to enhance patient safety and reduce the risk of catheter overflow. The system continuously monitors urine volume using a load cell sensor and sends real-time data to an IoT platform for remote monitoring.",
                
                title_weight: "Weight Monitoring Module:",
                title_alert: "Alert System:",
                
                desc_li1: "Measures the weight of urine collected in the catheter bag in real time.",
                desc_li2: "Activates a buzzer and sends notifications when preset weight thresholds are reached.",
                crit_goals: "Critical Goals:",
                desc_p2: "To provide timely alerts when the catheter bag reaches critical weight levels (e.g. 500g, 1000g, and 1500g), helping caregivers take immediate action to prevent overflow and improve patient care.",
                lbl_weight: "Current Urine Weight (KG)",
                lbl_status: "Urine Status Message (Level)",
                lbl_total_changes: "Total Catheter Changes Logged",
                chart_title: "Urine Weight Accumulation Trend (Last 50 Readings)",
                chart_desc: "This chart shows the accumulation of urine weight over time with the critical 1.5kg limit.",
                chart_legend: "Red dashed line: Critical Limit (1.5kg)",
                log_title: "Catheter Maintenance Log",
                col_date: "Date",
                col_time: "Time",
                tele_desc: "The Flask API manages notifications. Token/Chat ID configuration is stored in PostgreSQL.",
                log_action_desc: "Press this button to record a catheter change and reset the simulated weight.",
                btn_log: "LOG CATHETER CHANGE",
                
                // NEW KEYS
                title_data_mgmt: "Data Management (Export & Reset)",
                desc_data_mgmt: "Download maintenance logs to Excel before clearing them from the system.",
                btn_export: "EXPORT EXCEL / CSV",
                btn_clear_server: "CLEAR ALL LOGS (START FRESH)",
                
                status_safe: "Catheter still in safe level",
                status_warning: "Warning: Level approaching limit",
                status_danger: "DANGER: Critical Limit Reached!",
                status_unknown: "Waiting for sensor data..."
            },
            ms: {
                nav_console: "KONSOL",
                nav_overview: "Gambaran Projek",
                nav_analytics: "ANALITIK KRITIKAL",
                nav_history: "Sejarah Berat Urine",
                nav_control: "SISTEM KAWALAN",
                nav_config: "Konfigurasi Penyelenggaraan",
                nav_device: "Status Peranti",
                nav_debug: "Konsol Debug",
                last_updated: "Terakhir dikemas kini:",
                mission_title: "Misi & Matlamat Projek",
                group_members: "Ahli Kumpulan (Kumpulan 3)",
                desc_p1: "Projek ini menumpukan kepada pembangunan sistem pemantauan kateter berasaskan IoT untuk meningkatkan keselamatan pesakit dan mengurangkan risiko limpahan kateter. Sistem ini memantau isipadu air kencing secara berterusan menggunakan sensor load cell dan menghantar data masa nyata ke platform IoT untuk pemantauan jarak jauh.",
                
                title_weight: "Modul Pemantauan Berat:",
                title_alert: "Sistem Amaran:",

                desc_li1: "Mengukur berat air kencing yang dikumpul dalam beg kateter dalam masa nyata.",
                desc_li2: "Mengaktifkan buzzer dan menghantar notifikasi apabila had berat pratetap dicapai.",
                crit_goals: "Matlamat Kritikal:",
                desc_p2: "Untuk memberikan amaran tepat pada masanya apabila beg kateter mencapai tahap berat kritikal (cth. 500g, 1000g, dan 1500g), membantu penjaga mengambil tindakan segera untuk mengelakkan limpahan dan meningkatkan penjagaan pesakit.",
                lbl_weight: "Berat Urine Semasa (KG)",
                lbl_status: "Mesej Status Urine (Tahap)",
                lbl_total_changes: "Jumlah Penukaran Kateter Direkod",
                chart_title: "Trend Pengumpulan Berat Urine (50 Bacaan Terakhir)",
                chart_desc: "Graf ini menunjukkan pengumpulan berat air kencing dari masa ke masa dengan had kritikal 1.5kg.",
                chart_legend: "Garis putus merah: Had Kritikal (1.5kg)",
                log_title: "Log Penyelenggaraan Kateter",
                col_date: "Tarikh",
                col_time: "Masa",
                tele_desc: "API Flask menguruskan notifikasi. Konfigurasi Token/Chat ID disimpan dalam PostgreSQL.",
                log_action_desc: "Tekan butang ini untuk merekod penukaran kateter dan menetapkan semula berat simulasi.",
                btn_log: "REKOD PENUKARAN KATETER",
                
                // NEW KEYS
                title_data_mgmt: "Pengurusan Data (Eksport & Padam)",
                desc_data_mgmt: "Muat turun log penyelenggaraan ke Excel sebelum memadamnya dari sistem.",
                btn_export: "EKSPORT EXCEL / CSV",
                btn_clear_server: "PADAM SEMUA LOG (MULA BARU)",

                status_safe: "Kateter masih berada dalam paras selamat",
                status_warning: "Amaran: Paras menghampiri had",
                status_danger: "BAHAYA: Had Kritikal Dicapai!",
                status_unknown: "Menunggu data sensor..."
            }
        };

        function setLanguage(lang) {
            const keys = Object.keys(dictionary[lang]);
            keys.forEach(key => {
                const element = document.querySelector(`[data-key="${key}"]`);
                if (element) element.textContent = dictionary[lang][key];
                
                if (key === 'desc_p1') document.getElementById('desc_p1').textContent = dictionary[lang][key];
                if (key === 'desc_li1') document.getElementById('desc_li1').textContent = dictionary[lang][key];
                if (key === 'desc_li2') document.getElementById('desc_li2').textContent = dictionary[lang][key];
                if (key === 'desc_p2') document.getElementById('desc_p2').textContent = dictionary[lang][key];
                
                if (key === 'title_weight') document.getElementById('title_weight').textContent = dictionary[lang][key];
                if (key === 'title_alert') document.getElementById('title_alert').textContent = dictionary[lang][key];
                
                // New elements
                if (key === 'title_data_mgmt') document.getElementById('title_data_mgmt').textContent = dictionary[lang][key];
                if (key === 'desc_data_mgmt') document.getElementById('desc_data_mgmt').textContent = dictionary[lang][key];
            });
            
            const activePage = document.querySelector('.nav-item.active').getAttribute('data-page');
            const pageTitleEl = document.getElementById('mainTitle');
            const keyMap = { 'overview': 'nav_overview', 'weight_history': 'nav_history', 'alerts': 'nav_config', 'device_status': 'nav_device', 'debug': 'nav_debug' };
            if(dictionary[lang][keyMap[activePage]]) pageTitleEl.textContent = dictionary[lang][keyMap[activePage]];
            
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active-lang'));
            document.getElementById(`btn-${lang}`).classList.add('active-lang');
            
            currentLang = lang;
            localStorage.setItem('preferredLang', lang);
            manualRefresh();
        }

        const addDebugLog = (message, type = 'info') => {
            const debugLogs = document.getElementById('debugLogs');
            if (!debugLogs) return;
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log ${logClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugLogs.appendChild(logEntry);
            debugLogs.scrollTop = debugLogs.scrollHeight;
        };
        
        window.clearDebugLogs = () => {
            const debugLogs = document.getElementById('debugLogs');
            if (debugLogs) debugLogs.innerHTML = '<div class="debug-log">Logs cleared.</div>';
        };
        
        window.testAPIConnection = async () => {
            addDebugLog('Testing API...', 'info');
            try {
                const response = await fetch(API_URL + '/status');
                if (response.ok) {
                    addDebugLog('✓ API Connected!', 'success');
                    updateAPIStatus(true);
                } else {
                    addDebugLog('✗ API Error', 'error');
                    updateAPIStatus(false);
                }
            } catch (error) {
                addDebugLog('✗ Connection Failed', 'error');
                updateAPIStatus(false);
            }
        };
        
        window.manualRefresh = () => fetchDataFromAPI();
        
        const updateAPIStatus = (connected) => {
            const statusEl = document.getElementById('apiConnectionStatus');
            const esp32El = document.getElementById('esp32Connection');
            if (statusEl) {
                statusEl.textContent = connected ? 'API ONLINE' : 'API OFFLINE';
                statusEl.className = connected ? 'connection-status online' : 'connection-status offline';
            }
            if (esp32El) {
                esp32El.textContent = connected ? 'Connected' : 'Disconnected';
                esp32El.style.color = connected ? 'var(--fb-green)' : 'var(--fb-red)';
            }
        };
        
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h}h ${m}m ${s}s`;
        };
        
        const formatTimestamp = (ms) => {
            let timestamp = parseInt(ms);
            if (timestamp === 0) return "--:--:--";
            if (timestamp < 10000000000) timestamp *= 1000;
            if (timestamp < 946684800000) return new Date().toLocaleTimeString('en-US');
            return new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };

        const formatDateMY = (val) => {
            let ms = parseInt(val);
            if (!ms || ms === 0 || isNaN(ms)) return new Date().toLocaleDateString('en-GB'); 
            if (ms < 10000000000) ms *= 1000;
            if (ms < 946684800000) return new Date().toLocaleDateString('en-GB');

            const date = new Date(ms);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };
        
        const DOM = (id) => document.getElementById(id);
        const navItems = document.querySelectorAll('.nav-item');
        const sidebar = DOM('sidebar');
        const sidebarToggle = DOM('sidebarToggle');

        const closeSidebar = () => { if (window.innerWidth <= 768 && sidebar) sidebar.classList.remove('active'); };
        const pageToContentId = (pageId) => {
            if(pageId === 'overview') return 'contentOverview';
            if(pageId === 'weight_history') return 'contentWeightHistory';
            if(pageId === 'alerts') return 'contentAlerts';
            if(pageId === 'device_status') return 'contentDeviceStatus';
            if(pageId === 'debug') return 'contentDebug';
            return 'contentOverview';
        };

        const initCharts = (pageId) => {
            if (typeof Chart === 'undefined') return;
            Chart.register(window['chartjs-plugin-annotation']); 
            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { bodyColor: '#202124', titleColor: '#202124', backgroundColor: '#F0F0F0', borderColor: '#3c4043', borderWidth: 1 } },
                scales: {
                    y: { ticks: { color: '#FFFFFF' }, grid: { color: '#3c4043' }, title: { display: false } },
                    x: { ticks: { color: '#FFFFFF' }, grid: { display: false } }
                }
            };
            if (pageId === 'weight_history' && !chartsInitialized.weight) {
                const canvas = DOM('detailedWeightChart');
                if (canvas) {
                    detailedWeightChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: { 
                            labels: chartDataBuffer.labels, 
                            datasets: [{ 
                                label: 'Weight (kg)', data: chartDataBuffer.weight, 
                                borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', 
                                tension: 0.2, pointRadius: 4, pointBackgroundColor: '#FFFFFF' 
                            }] 
                        },
                        options: { 
                            ...defaultOptions, 
                            plugins: { 
                                ...defaultOptions.plugins, 
                                annotation: { 
                                    annotations: { 
                                        criticalLimit: { 
                                            type: 'line', yMin: MAX_WEIGHT_KG, yMax: MAX_WEIGHT_KG, 
                                            borderColor: '#FF0000', borderWidth: 3, borderDash: [8, 4], 
                                            label: { content: 'CRITICAL LIMIT (1.5 KG)', enabled: true, position: 'start', backgroundColor: 'var(--fb-red)', color: '#FFFFFF'} 
                                        } 
                                    } 
                                } 
                            }, 
                            scales: { 
                                ...defaultOptions.scales, 
                                y: { ...defaultOptions.scales.y, min: 0, max: MAX_WEIGHT_KG * 1.1, suggestedMax: MAX_WEIGHT_KG * 1.05, border: { color: '#3c4043' }, title: { display: true, text: 'Urine Weight (KG)', color: '#FFFFFF' }, ticks: { color: '#FFFFFF' }, grid: { color: '#3c4043' } }, 
                                x: { ...defaultOptions.scales.x, ticks: { color: '#FFFFFF' } } 
                            } 
                        }
                    });
                    chartsInitialized.weight = true;
                }
            }
        };

        const switchPage = (pageId) => {
            if (pageId === 'debug') {
                const password = prompt("Enter Security Password:");
                if (password !== "urotech123") { alert("Incorrect Password!"); return; }
            }
            document.querySelectorAll('.page-content').forEach(content => content.style.display = 'none');
            const contentId = pageToContentId(pageId);
            const activeContent = DOM(contentId); 
            if (!activeContent) return;
            activeContent.style.display = 'block';
            
            if (DOM('mainTitle')) {
                const keyMap = { 'overview': 'nav_overview', 'weight_history': 'nav_history', 'alerts': 'nav_config', 'device_status': 'nav_device', 'debug': 'nav_debug' };
                DOM('mainTitle').textContent = dictionary[currentLang][keyMap[pageId]] || "Console";
            }
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageId) item.classList.add('active');
            });
            closeSidebar();
            if (pageId === 'weight_history' && !chartsInitialized.weight) initCharts(pageId);
            setTimeout(() => { if (detailedWeightChart) detailedWeightChart.resize(); }, 100); 
        };

        const fetchDataFromAPI = async () => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); 
                const response = await fetch(API_URL + '/status', { signal: controller.signal, headers: { 'Accept': 'application/json' } });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error("Network response was not ok");
                const data = await response.json();
                
                if (DOM('rawAPIData')) DOM('rawAPIData').textContent = JSON.stringify(data, null, 2);
                updateAPIStatus(true);
                
                const metrics = data.current_metrics || {};
                const history = data.weight_history ? [...data.weight_history].reverse() : []; 
                const changeLogs = data.change_logs || [];

                updateMetrics(metrics, history, changeLogs);
                updateCharts(history);

            } catch (error) {
                updateAPIStatus(false);
            }
        };

        const updateMetrics = (metrics, history, changeLogs) => {
            const formattedWeight = metrics.weight_kg != null ? metrics.weight_kg.toFixed(2) : '--';
            if (DOM('currentWeightHistory')) DOM('currentWeightHistory').textContent = formattedWeight;
            
            if (DOM('changeCountHistory')) DOM('changeCountHistory').textContent = metrics.change_count || 0; 
            if (DOM('controlChangeCount')) DOM('controlChangeCount').textContent = metrics.change_count || 0; 
            
            let alertLevel = metrics.alert_level || 'UNKNOWN';
            let statusText = dictionary[currentLang]['status_unknown'];

            if (alertLevel === 'LEVEL_1500_DANGER') statusText = dictionary[currentLang]['status_danger'];
            else if (alertLevel === 'LEVEL_1000_REACHED') statusText = dictionary[currentLang]['status_warning'];
            else if (alertLevel === 'LEVEL_SAFE' || alertLevel === 'LEVEL_500_REACHED') statusText = dictionary[currentLang]['status_safe'];
            else statusText = dictionary[currentLang]['status_safe']; 

            if (DOM('weightStatusMessage')) {
                DOM('weightStatusMessage').textContent = statusText;
                if (alertLevel === 'LEVEL_1500_DANGER') DOM('weightStatusMessage').style.color = 'var(--fb-red)';
                else if (alertLevel === 'LEVEL_1000_REACHED') DOM('weightStatusMessage').style.color = 'var(--fb-yellow)';
                else DOM('weightStatusMessage').style.color = 'var(--fb-green)';
            }
            
            // --- FIX REAL TIME "LAST UPDATED" ---
            // If data fetch is successful, use the browser's current time to show "Real Time" activity
            if (DOM('lastUpdatedTime')) {
                DOM('lastUpdatedTime').textContent = new Date().toLocaleTimeString('en-US');
            }
            
            updateChangeLog(changeLogs, DOM('changeLogBodyHistory'));
        };

        const updateCharts = (history) => {
            if (history.length >= 2) {
                chartDataBuffer.labels = history.map(h => formatTimestamp(h.timestamp));
                chartDataBuffer.weight = history.map(h => h.weight || 0);
                if (detailedWeightChart) {
                    detailedWeightChart.data.labels = chartDataBuffer.labels;
                    detailedWeightChart.data.datasets[0].data = chartDataBuffer.weight;
                    detailedWeightChart.update('none');
                }
            }
        };

        const updateChangeLog = (changeLogs, targetElement) => {
            if (!targetElement) return;
            let logHtml = '';
            changeLogs.forEach(log => {
                logHtml += `
                    <tr>
                        <td style="color: var(--fb-primary);">${log.id}</td>
                        <td style="color: white;">${formatDateMY(log.timestamp)}</td>
                        <td style="color: white;">${formatTimestamp(log.timestamp)}</td>
                    </tr>
                `;
            });
            targetElement.innerHTML = logHtml.length > 0 ? logHtml : '<tr><td colspan="3" style="text-align: center; padding: 10px; color: var(--fb-text-secondary);">No records found.</td></tr>';
        };

        window.logCatheterChange = async () => {
            addDebugLog('Logging change...', 'info');
            try {
                const response = await fetch(API_URL + '/log_change', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                if (response.ok) {
                    showToast('Success', 'Catheter change logged.', 'success');
                    setTimeout(fetchDataFromAPI, 500);
                } else throw new Error("Failed");
            } catch (error) { showToast('Error', 'Failed to log change', 'danger'); }
        };

        // --- NEW FUNCTION: EXPORT EXCEL ---
        window.exportExcel = () => {
            // Ini akan memanggil endpoint Python yang kita baru buat
            // Browser akan automatik start download
            window.location.href = API_URL + '/export_maintenance_log';
            showToast('Downloading', 'Preparing Excel file...', 'info');
        };

        // --- NEW FUNCTION: CLEAR SERVER LOGS ---
        window.clearServerLogs = async () => {
            if(!confirm("⚠️ WARNING: This will DELETE ALL HISTORY from the SERVER.\n\nAll devices (Laptop/Phone) will be reset to 0.\nHave you exported the data first?\n\nContinue?")) return;
            
            addDebugLog('Clearing server logs...', 'warning');
            try {
                const response = await fetch(API_URL + '/clear_maintenance_log', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({}) 
                });
                
                if (response.ok) {
                    showToast('System Reset', 'All history cleared. System restarted.', 'success');
                    // Reset Local Offset just in case
                    localStorage.setItem('catheterLogOffset', 0);
                    setTimeout(fetchDataFromAPI, 1000);
                } else throw new Error("Failed");
            } catch (error) { showToast('Error', 'Failed to clear logs', 'danger'); }
        };

        window.showToast = (title, message, type = 'info') => {
            const toast = DOM('toast');
            if (!toast) return;
            const color = type === 'success' ? 'var(--fb-green)' : type === 'danger' ? 'var(--fb-red)' : 'var(--fb-primary)';
            DOM('toastTitle').style.color = color;
            DOM('toastTitle').textContent = title;
            DOM('toastMessage').textContent = message;
            toast.style.borderLeftColor = color;
            DOM('toastIcon').style.color = color;
            toast.style.display = 'flex';
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.style.display = 'none', 500); }, 3000);
        };

        document.addEventListener('DOMContentLoaded', () => {
            navItems.forEach(item => item.addEventListener('click', () => switchPage(item.getAttribute('data-page'))));
            if (sidebarToggle) sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('active'));
            setLanguage(currentLang);
            switchPage('overview'); 
            testAPIConnection();
            fetchIntervalId = setInterval(fetchDataFromAPI, FETCH_INTERVAL); 
            setInterval(() => { if (DOM('deviceUptime')) { const uptime = Math.floor((Date.now() - window.startTime) / 1000); DOM('deviceUptime').textContent = formatTime(uptime); } }, 1000);
            window.startTime = Date.now();
        });
    </script>
</body>
</html>